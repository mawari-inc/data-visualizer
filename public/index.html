<!DOCTYPE html>
<html>
<head>
	<title>Mawari Data Visualizer</title>
	<style type="text/css">
		.active {
			background: #eee;
		}
		body {
			width: 100%;
			max-width: 1200px;
			margin: 0 auto;
		}
		table {
			width: 100%;
		}
		#chart-timeline {
			height: 600px;
			background: #eee;
		}
		.button {

		}
		.table-data {
			
		}
		.table-column {
			min-width: 90px;
		}
	</style>
</head>
<body>
	<h1>Mawari Data Visualizer</h1>
	<h2>Impressions Timeline</h2>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E=" crossorigin="anonymous"></script>
	<div>
		<canvas id="chart-timeline"></canvas>
		<button id="button-impressions" class="button">Impressions</button>
		<button id="button-actions" class="button">Actions</button>
		<button id="button-rates" class="button">Rates</button>
	</div>
	<h2>Creatives</h2>
	<table>
		<tr>
			<td style="vertical-align: top; width: 800px;" rowspan="3">
				<div>
					<table class="table-data"></table>
				</div>
			</td>
			<td style="vertical-align: top; height: 300px;">
				<div>
					<canvas id="chart-doughnut-impressions"></canvas>
				</div>
			</td>
		</tr>
		<tr>
			<td style="vertical-align: top; height: 300px;">
				<div>
					<canvas id="chart-doughnut-variants"></canvas>
				</div>
			</td>
		</tr>
		<tr>
			<td style="vertical-align: top; height: 600px;">
				<div>
					<canvas id="chart-bar-interactions"></canvas>
				</div>
			</td>
		</tr>
	</table>
	<script>
		const creativeTableURL = "/creatives";

		const $buttonImpressions = $("#button-impressions").click(e => renderTimeline(impressionData));
		const $buttonActions = $("#button-actions").click(e => renderTimeline(actionData));
		const $buttonRates = $("#button-rates").click(e => renderTimeline(rateData));

		fetch(creativeTableURL).then(res => res.json()).then(data => {
			renderCreativeTable(data);
			showCreative(data[0].creativeId);
			$(".table-data tr:nth-child(2)").addClass("active");
		});

		var impressionData = {
			labels: [],
			datasets: [
				{
					label: "Impressions per Interval",
					backgroundColor: "#3E95CD",
					borderColor: "#3E95CD",
					fill: false,
					data: []
				},
				{
					label: "Interactions per Interval",
					backgroundColor: "#95CD3E",
					borderColor: "#95CD3E",
					fill: false,
					data: []
				},
				{
					label: "Clicks per Interval",
					backgroundColor: "#CD3E95",
					borderColor: "#CD3E95",
					fill: false,
					data: []
				}
			]
		};

		var actionData = {
			labels: [],
			datasets: [
				{
					label: "Rotations per Interval",
					backgroundColor: "#3E95CD",
					borderColor: "#3E95CD",
					fill: false,
					data: []
				},
				{
					label: "Zooms per Interval",
					backgroundColor: "#95CD3E",
					borderColor: "#95CD3E",
					fill: false,
					data: []
				},
				{
					label: "Variants per Interval",
					backgroundColor: "#CD3E95",
					borderColor: "#CD3E95",
					fill: false,
					data: []
				},
				{
					label: "Resets per Interval",
					backgroundColor: "#000000",
					borderColor: "#000000",
					fill: false,
					data: []
				}
			]
		};

		var rateData = {
			labels: [],
			datasets: [
				{
					label: "Interactions / Impressions per Interval",
					backgroundColor: "#3E95CD",
					borderColor: "#3E95CD",
					fill: false,
					data: []
				},
				{
					label: "Clicks / Impressions per Interval",
					backgroundColor: "#95CD3E",
					borderColor: "#95CD3E",
					fill: false,
					data: []
				}
			]
		};

		var impressionBreakdownData = {
			labels: ["Impressions", "Interactions", "Clicks"],
			datasets: [{
				label: "Event Count",
				backgroundColor: ["#3E95CD", "#95CD3E","#CD3E95"],
				data: []
			}]
		};

		var variantBreakdownData = {
			labels: [],
			datasets: [{
				label: "Color Breakdown",
				backgroundColor: [],
				data: []
			}]
		};

		var interactionTimeData = {
			labels: ["< 1", "1~2", "2~3", "3~4", "4~5", "5~7", "7~10", "> 10"],
			datasets: [{
				label: "Interaction Times (seconds)",
				backgroundColor: "#3E95CD",
				data: []
			}]
		};

		function generateImpressionBreakdown(res) {
			impressionBreakdownData.datasets[0].data = [res.impressionCount, res.interactionCount, res.clickCount];

			// clean canvas to avoid rendering bug
			const $canvas = $("#chart-doughnut-impressions");
			$("#chart-doughnut-impressions").after("<canvas id=\"chart-doughnut-impressions\"></canvas>");
			$canvas.remove();

			// populate canvas with chart
			var ctx2 = document.getElementById("chart-doughnut-impressions").getContext("2d");
			var doughnut = new Chart(ctx2, {
				// The type of chart we want to create
				type: "doughnut",

		    	// The data for our dataset
		    	data: impressionBreakdownData,

	    		// Configuration options go here
	    		options: {}
	    	});
		};

		function generateVariantBreakdown(res) {
			// clear data
			variantBreakdownData.labels = [];
			variantBreakdownData.datasets[0].data = [];
			variantBreakdownData.datasets[0].backgroundColor = [];

			// iterate through events, check for variant, if new variant found push, if old variant found increment
			res.events.forEach(item => {
				if (item.eventType === "variant") {
					var variant = variantBreakdownData.labels.find(v => v === item.eventData.id);
					if (variant != null) {
						variantBreakdownData.datasets[0].data[variantBreakdownData.labels.indexOf(variant)]++;
					}
					else {
						variantBreakdownData.labels.push(item.eventData.id);
						variantBreakdownData.datasets[0].data.push(1);
						variantBreakdownData.datasets[0].backgroundColor.push(item.eventData.id);
					}
				}
			});

			// clean canvas to avoid rendering bug
			const $canvas = $("#chart-doughnut-variants");
			$("#chart-doughnut-variants").after("<canvas id=\"chart-doughnut-variants\"></canvas>");
			$canvas.remove();

			// populate canvas with chart
			var ctx3 = document.getElementById("chart-doughnut-variants").getContext("2d");
			var doughnut = new Chart(ctx3, {
				// The type of chart we want to create
				type: "doughnut",

		    	// The data for our dataset
		    	data: variantBreakdownData,

	    		// Configuration options go here
	    		options: {}
	    	});
		};

		function Session(sessionId) {
			this.sessionId = sessionId;
			this.hasInteraction = false;
			this.interactionStart = 0;
			this.interactionEnd = 0;
			this.events = [];
		};

		function generateInteractionTimes(data) {
			//clear data
			interactionTimeData.datasets[0].data = [];

			for (var i = 0; i < interactionTimeData.labels.length; i++)
				interactionTimeData.datasets[0].data.push(0);

			const sessions = [];

			data.events.forEach(item => {
				var session = sessions.find(s => s.sessionId == item.sessionId);
				if (session == null) {
					sessions.push(new Session(item.sessionId));
					sessions[sessions.length - 1].events.push(item);
				}
				else {
					session.events.push(item);
				}
			});

			if (sessions.length > 0) {
				sessions.forEach(session => {
					// init stuff

					session.events.forEach(event => {
						if (event.eventType === "first-interaction" || event.eventType === "first-click") {
							session.hasInteraction = true;
							session.interactionStart = event.dateTime;
							session.interactionEnd = event.dateTime;
						}
					});

					if (session.hasInteraction) {
						session.events.forEach(event => {
							if (event.eventType === "rotation" || event.eventType === "zoom" || event.eventType === "variant" || event.eventType === "reset") {
								if (event.dateTime > session.interactionEnd) session.interactionEnd = event.dateTime;
							}
						});
					}
				});

				sessions.forEach(session => {
					if (session.hasInteraction) {
						var interactionTime = session.interactionEnd - session.interactionStart;

						if (interactionTime < 1000)
							interactionTimeData.datasets[0].data[0]++;
						else if (interactionTime < 2000)
							interactionTimeData.datasets[0].data[1]++;
						else if (interactionTime < 3000)
							interactionTimeData.datasets[0].data[2]++;
						else if (interactionTime < 4000)
							interactionTimeData.datasets[0].data[3]++;
						else if (interactionTime < 5000)
							interactionTimeData.datasets[0].data[4]++;
						else if (interactionTime < 7000)
							interactionTimeData.datasets[0].data[5]++;
						else if (interactionTime < 10000)
							interactionTimeData.datasets[0].data[6]++;
						else 
							interactionTimeData.datasets[0].data[7]++;
					}
				});
			}
			else {
				console.log("ERROR: No sessions generated");
			}

			// clean canvas to avoid rendering bug
			const $canvas = $("#chart-bar-interactions");
			$("#chart-bar-interactions").after("<canvas id=\"chart-bar-interactions\"></canvas>");
			$canvas.remove();

			// populate canvas with chart
			var ctx4 = document.getElementById("chart-bar-interactions").getContext("2d");
			var horizontalBar = new Chart(ctx4, {
				// The type of chart we want to create
				type: "horizontalBar",

		    	// The data for our dataset
		    	data: interactionTimeData,

	    		// Configuration options go here
	    		options: {
	    			responsive: true
	    		}
	    	});
		};

		function generateTimelines(res) {
			// clear data
			impressionData.labels = [];
			impressionData.datasets[0].data = [];
			impressionData.datasets[1].data = [];
			impressionData.datasets[2].data = [];
			actionData.labels = [];
			actionData.datasets[0].data = [];
			actionData.datasets[1].data = [];
			actionData.datasets[2].data = [];
			actionData.datasets[3].data = [];
			rateData.labels = [];
			rateData.datasets[0].data = [];
			rateData.datasets[1].data = [];

			// number of data points to show
			var numDataPoints
			if (res.events.length > 240) numDataPoints = 240;
			else numDataPoints = res.events.length;

			// find oldest event
			const dateTimes = res.events.map(d => new Date(d.dateTime).getTime());
			var lowerBounds = dateTimes[0];
			dateTimes.forEach(dateTime => {
				if (dateTime < lowerBounds) lowerBounds = dateTime;
			});

			// set upper bounds to now
			const upperBounds = new Date(Date.now()).getTime();

			// set total time period to work with
			const totalBounds = upperBounds - lowerBounds;

			// set time step size
			const stepSize = Math.floor(totalBounds / numDataPoints);
			
			// begin at lower bounds
			var timeStep = lowerBounds;

			// generate time labels
			for (var i = 0; i < numDataPoints; i++) {
				var minutes = new Date(timeStep).getMinutes();
				var hour = new Date(timeStep).getHours();
				var day = new Date(timeStep).getDate();
				var month = new Date(timeStep).getMonth() + 1;

				var timeString = 
				(month < 10 ? "0" + month : month) + "-" + 
				(day < 10 ? "0" + day : day) + "-" + 
				(hour < 10 ? "0" + hour : hour) + ":" + 
				(minutes < 10 ? "0" + minutes : minutes);

				impressionData.labels.push(timeString);
				impressionData.datasets[0].data.push(0);
				impressionData.datasets[1].data.push(0);
				impressionData.datasets[2].data.push(0);
				actionData.labels.push(timeString);
				actionData.datasets[0].data.push(0);
				actionData.datasets[1].data.push(0);
				actionData.datasets[2].data.push(0);
				actionData.datasets[3].data.push(0);
				rateData.labels.push(timeString);

				timeStep += stepSize;
			}

			// sort all events into the time step buckets
			res.events.forEach(item => {
				if (item.eventType === "impression") {
					impressionData.datasets[0].data[Math.floor((item.dateTime - lowerBounds) / stepSize)]++;
				}
				if (item.eventType === "first-interaction" || item.eventType === "first-click") {
					impressionData.datasets[1].data[Math.floor((item.dateTime - lowerBounds) / stepSize)]++;
				}
				if (item.eventType === "click-through") {
					impressionData.datasets[2].data[Math.floor((item.dateTime - lowerBounds) / stepSize)]++;
				}
				if (item.eventType === "rotation") {
					actionData.datasets[0].data[Math.floor((item.dateTime - lowerBounds) / stepSize)]++;
				}
				if (item.eventType === "zoom") {
					actionData.datasets[1].data[Math.floor((item.dateTime - lowerBounds) / stepSize)]++;
				}
				if (item.eventType === "variant") {
					actionData.datasets[2].data[Math.floor((item.dateTime - lowerBounds) / stepSize)]++;
				}
				if (item.eventType === "reset") {
					actionData.datasets[3].data[Math.floor((item.dateTime - lowerBounds) / stepSize)]++;
				}
			});

			for (var i = 0; i < numDataPoints; i++) {
				if (impressionData.datasets[0].data[i] == 0) {
					rateData.datasets[0].data.push(0);
					rateData.datasets[1].data.push(0);
				}
				else {
					rateData.datasets[0].data.push(impressionData.datasets[1].data[i] / impressionData.datasets[0].data[i]);
					rateData.datasets[1].data.push(impressionData.datasets[2].data[i] / impressionData.datasets[0].data[i]);
				}
			}

			renderTimeline(impressionData);
		};

		function renderTimeline(data) {
			// clean canvas to avoid rendering bug
			const $canvas = $("#chart-timeline");
			$("#chart-timeline").after("<canvas id=\"chart-timeline\"></canvas>");
			$canvas.remove();

			// populate canvas with chart
			var ctx1 = document.getElementById("chart-timeline").getContext("2d");
			var chart = new Chart(ctx1, {
		    	// The type of chart we want to create
		    	type: "line",

		    	// The data for our dataset
		    	data: data,

	    		// Configuration options go here
	    		options: {}
	    	});
		};

		function showCreative (creativeId, e) {
			if (e) {
				$("tr").removeClass("active");
				$(e.target).closest("tr").addClass("active");
			}

			const creativeDataURL = "/creatives/" + creativeId;

			fetch(creativeDataURL).then(data => data.json()).then(res => {
				generateInteractionTimes(res);
				generateTimelines(res);
				generateImpressionBreakdown(res);
				generateVariantBreakdown(res);

				// regenerate charts
			}).catch(error => {
				console.log(error);
			});
		};

		function renderCreativeTable(tableData) {
			var $table = $(".table-data");

			var cols = Object.keys(tableData[0]);
			$table.append("<thead><tr>" + cols.map(col => "<th class=\"table-column\">" + col + "</th>").join("") + "</tr></thead>");


			tableData.map(function(row) {
				var cols = Object.values(row);
				const $row = $("<tr>" + cols.map(col => "<td>" + col + "</td>").join("")  + "</tr>");
				const $button = $("<button>View</button>").click(e => showCreative(row.creativeId, e));
				$row.append($button);
				$table.append($row);
			});
		};
	</script>
</body>
</html>
