<!DOCTYPE html>
<html>
<head>
	<title>Mawari Data Visualizer</title>
	<style type="text/css">
		.active {
			background: #eee;
		}
		body {
			width: 100%;
			max-width: 1200px;
			margin: 0 auto;
		}
		table {
			width: 100%;
		}
		#chart1 {
			height: 600px;
			background: #eee;
		}
		.table-data {
			
		}
		.table-column {
			min-width: 90px;
		}
	</style>
</head>
<body>
	<h1>Mawari Data Visualizer</h1>
	<h2>Impressions Timeline</h2>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E=" crossorigin="anonymous"></script>
	<div>
		<canvas id="chart1"></canvas>
	</div>
	<h2>Creatives</h2>
	<table>
		<tr>
			<td style="vertical-align: top;">
				<div style="width: 800px;">
					<table class="table-data"></table>
				</div>
			</td>
			<td style="vertical-align: top;">
				<div style="height: 600px;">
					<canvas id="chart2"></canvas>
				</div>
			</td>
		</tr>
	</table>
	<script>
		const creativeTableURL = "/creatives";

		fetch(creativeTableURL).then(res => res.json()).then(data => {
			renderTable(data);
			showCreative(data[0].creativeId);
			$(".table-data tr:nth-child(2)").addClass("active");
		});

		var chartData = {
			labels: [],
			datasets: [{
				label: "Impressions per Interval",
				backgroundColor: "rgb(255, 99, 132)",
				borderColor: "rgb(255, 99, 132)",
				data: []
			}]
		};

		var doughnutData = {
			labels: ["Impressions", "Interactions", "Clicks"],
			datasets: [{
				label: "Event Count",
				backgroundColor: ["#3e95cd", "#8e5ea2","#3cba9f"],
				data: []
			}]
		};

		function generateDoughnut(res) {
			doughnutData.datasets[0].data = [res.impressionCount, res.interactionCount, res.clickCount];

			const $canvas = $("#chart2");
			$("#chart2").after('<canvas id="chart2"></canvas>');
			$canvas.remove();
			var ctx2 = document.getElementById("chart2").getContext("2d");
			var doughnut = new Chart(ctx2, {
				// The type of chart we want to create
				type: "doughnut",

		    	// The data for our dataset
		    	data: doughnutData,

	    		// Configuration options go here
	    		options: {}
	    	});
		};

		function generateTimeline(res) {
			chartData.labels = [];
			chartData.datasets[0].data = [];

			var dateTimes = res.events.map(d => new Date(d.dateTime).getTime());
			var lowerBounds = dateTimes[0];
			dateTimes.forEach(dateTime => {
				if (dateTime < lowerBounds) lowerBounds = dateTime;
			});
			//console.log("Lower Bounds: " + lowerBounds);
			var upperBounds = new Date(Date.now()).getTime();
			//console.log("Upper Bounds: " + upperBounds);
			var period = upperBounds - lowerBounds;
			//console.log("Period:       " + period);
			var size = Math.floor(period / 600000);
			//console.log("Size:         " + size);

			var timeStep = lowerBounds;

			for (var i = 0; i < size; i++) {
				var minutes = new Date(timeStep).getMinutes();
				var hour = new Date(timeStep).getHours();
				var day = new Date(timeStep).getDate();
				var month = new Date(timeStep).getMonth() + 1;

				var timeString = 
				(month < 10 ? "0" + month : month) + "-" + 
				(day < 10 ? "0" + day : day) + "-" + 
				(hour < 10 ? "0" + hour : hour) + ":" + 
				(minutes < 10 ? "0" + minutes : minutes);

				chartData.labels.push(timeString);
				chartData.datasets[0].data.push(0);

				timeStep += 600000;
			}

			res.events.forEach(item => {
				chartData.datasets[0].data[Math.floor((item.dateTime - lowerBounds + 60000) / 600000)] += item.impressionCount;
			});

			var ctx1 = document.getElementById("chart1").getContext("2d");
			var chart = new Chart(ctx1, {
		    	// The type of chart we want to create
		    	type: "line",

		    	// The data for our dataset
		    	data: chartData,

	    		// Configuration options go here
	    		options: {}
	    	});
		};

		function showCreative (creativeId, e) {
			if (e) {
				$("tr").removeClass("active");
				$(e.target).closest("tr").addClass("active");
			}

			const creativeDataURL = "/creatives/" + creativeId;

			fetch(creativeDataURL).then(data => data.json()).then(res => {
				generateTimeline(res);
				generateDoughnut(res);

				// regenerate charts
			}).catch(error => {
				console.log(error);
			});
		};

		function renderTable(tableData) {
			var $table = $(".table-data");

			var cols = Object.keys(tableData[0]);
			$table.append("<thead><tr>" + cols.map(col => "<th class=\"table-column\">" + col + "</th>").join("") + "</tr></thead>");


			tableData.map(function(row) {
				var cols = Object.values(row);
				const $row = $("<tr>" + cols.map(col => "<td>" + col + "</td>").join("")  + "</tr>");
				const $button = $("<button>View</button>").click(e => showCreative(row.creativeId, e));
				$row.append($button);
				$table.append($row);
			});
		};
	</script>
</body>
</html>
