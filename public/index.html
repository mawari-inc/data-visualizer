<!DOCTYPE html>
<html>
<head>
	<title>Mawari Data Visualizer</title>
	<style type="text/css">
		.active {
			background: #eee;
		}
		body {
			width: 100%;
			max-width: 1200px;
			margin: 0 auto;
		}
		table {
			width: 100%;
		}
		#chart-timeline {
			height: 600px;
			background: #eee;
		}
		.button {
			
		}
		.table-data {
			
		}
		.table-column {
			min-width: 90px;
		}
	</style>
</head>
<body>
	<h1>Mawari Data Visualizer</h1>
	<h2>Impressions Timeline</h2>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E=" crossorigin="anonymous"></script>
	<div>
		<canvas id="chart-timeline"></canvas>
		<button id="button-impressions" class="button">Impressions</button>
		<button id="button-actions" class="button">Actions</button>
		<button id="button-rates" class="button">Rates</button>
		<button id="button-engagement" class="button">Engagement</button>
	</div>
	<h2>Creatives</h2>
	<table>
		<tr>
			<td style="vertical-align: top; width: 800px;" rowspan="3">
				<div>
					<table class="table-data"></table>
				</div>
			</td>
			<td style="vertical-align: top; height: 300px;">
				<div>
					<canvas id="chart-doughnut-impressions"></canvas>
				</div>
			</td>
		</tr>
		<tr>
			<td style="vertical-align: top; height: 300px;">
				<div>
					<canvas id="chart-doughnut-variants"></canvas>
				</div>
			</td>
		</tr>
		<tr>
			<td style="vertical-align: top; height: 600px;">
				<div>
					<canvas id="chart-bar-engagement"></canvas>
				</div>
			</td>
		</tr>
	</table>
	<script>
		const creativeTableURL = "/creative";

		const $buttonImpressions = $("#button-impressions").click(e => renderTimeline(impressionTimeline));
		const $buttonActions = $("#button-actions").click(e => renderTimeline(actionTimeline));
		const $buttonRates = $("#button-rates").click(e => renderTimeline(rateTimeline));
		const $buttonInteractions = $("#button-engagement").click(e => renderTimeline(engagementTimeline));

		const maxInteractionTime = 60000;

		var sessions = [];

		fetch(creativeTableURL).then(res => res.json()).then(data => {
			renderCreativeTable(data);
			showCreative(data[0].creativeId);
			$(".table-data tr:nth-child(2)").addClass("active");
		});

		var impressionTimeline = {
			labels: [],
			datasets: [
				{
					label: "Impressions per Interval",
					backgroundColor: "#3E95CD",
					borderColor: "#3E95CD",
					fill: false,
					data: []
				},
				{
					label: "Interactions per Interval",
					backgroundColor: "#95CD3E",
					borderColor: "#95CD3E",
					fill: false,
					data: []
				},
				{
					label: "Clicks per Interval",
					backgroundColor: "#CD3E95",
					borderColor: "#CD3E95",
					fill: false,
					data: []
				}
			]
		};

		var engagementTimeline = {
			labels: [],
			datasets: [
				{
					label: "Average Engagement Time per Interval (seconds)",
					backgroundColor: "#3E95CD",
					borderColor: "#3E95CD",
					fill: false,
					data: []
				}
			]
		};

		var actionTimeline = {
			labels: [],
			datasets: [
				{
					label: "Rotations per Interval",
					backgroundColor: "#3E95CD",
					borderColor: "#3E95CD",
					fill: false,
					data: []
				},
				{
					label: "Zooms per Interval",
					backgroundColor: "#95CD3E",
					borderColor: "#95CD3E",
					fill: false,
					data: []
				},
				{
					label: "Variant Changes per Interval",
					backgroundColor: "#CD3E95",
					borderColor: "#CD3E95",
					fill: false,
					data: []
				},
				{
					label: "Resets per Interval",
					backgroundColor: "#000000",
					borderColor: "#000000",
					fill: false,
					data: []
				}
			]
		};

		var rateTimeline = {
			labels: [],
			datasets: [
				{
					label: "Interactions / Impressions per Interval",
					backgroundColor: "#3E95CD",
					borderColor: "#3E95CD",
					fill: false,
					data: []
				},
				{
					label: "Clicks / Impressions per Interval",
					backgroundColor: "#95CD3E",
					borderColor: "#95CD3E",
					fill: false,
					data: []
				}
			]
		};

		var impressionBreakdown = {
			labels: ["Impressions", "Interactions", "Clicks"],
			datasets: [{
				label: "Event Count",
				backgroundColor: ["#3E95CD", "#95CD3E","#CD3E95"],
				data: []
			}]
		};

		var variantBreakdown = {
			labels: [],
			datasets: [{
				label: "Variant Breakdown",
				backgroundColor: [],
				data: []
			}]
		};

		var engagementBars = {
			labels: ["< 1", "1~2", "2~3", "3~4", "4~5", "5~7", "7~10", "> 10"],
			datasets: [{
				label: "Engagement Times (seconds)",
				backgroundColor: "#3E95CD",
				data: []
			}]
		};

		function renderBreakdowns() {
			var $canvas;

			// clean canvas to avoid rendering bug
			$canvas = $("#chart-doughnut-impressions");
			$("#chart-doughnut-impressions").after("<canvas id=\"chart-doughnut-impressions\"></canvas>");
			$canvas.remove();

			// populate canvas with chart
			var ctx2 = document.getElementById("chart-doughnut-impressions").getContext("2d");
			var doughnutImpressions = new Chart(ctx2, {
				// The type of chart we want to create
				type: "doughnut",

		    	// The data for our dataset
		    	data: impressionBreakdown,

	    		// Configuration options go here
	    		options: {}
	    	});

			// clean canvas to avoid rendering bug
			$canvas = $("#chart-doughnut-variants");
			$("#chart-doughnut-variants").after("<canvas id=\"chart-doughnut-variants\"></canvas>");
			$canvas.remove();

			// populate canvas with chart
			var ctx3 = document.getElementById("chart-doughnut-variants").getContext("2d");
			var doughnutVariants = new Chart(ctx3, {
				// The type of chart we want to create
				type: "doughnut",

		    	// The data for our dataset
		    	data: variantBreakdown,

	    		// Configuration options go here
	    		options: {}
	    	});

	    	// clean canvas to avoid rendering bug
			$canvas = $("#chart-bar-engagement");
			$("#chart-bar-engagement").after("<canvas id=\"chart-bar-engagement\"></canvas>");
			$canvas.remove();

			// populate canvas with chart
			var ctx4 = document.getElementById("chart-bar-engagement").getContext("2d");
			var horizontalBarInteractions = new Chart(ctx4, {
				// The type of chart we want to create
				type: "horizontalBar",

		    	// The data for our dataset
		    	data: engagementBars,

	    		// Configuration options go here
	    		options: {
	    			responsive: true
	    		}
	    	});
		};

		function generateChartsData(creative) {
			// clear data
			impressionTimeline.labels = [];
			impressionTimeline.datasets[0].data = [];
			impressionTimeline.datasets[1].data = [];
			impressionTimeline.datasets[2].data = [];
			actionTimeline.labels = [];
			actionTimeline.datasets[0].data = [];
			actionTimeline.datasets[1].data = [];
			actionTimeline.datasets[2].data = [];
			actionTimeline.datasets[3].data = [];
			rateTimeline.labels = [];
			rateTimeline.datasets[0].data = [];
			rateTimeline.datasets[1].data = [];
			engagementTimeline.labels = [];
			engagementTimeline.datasets[0].data = [];
			variantBreakdown.labels = [];
			variantBreakdown.datasets[0].data = [];
			variantBreakdown.datasets[0].backgroundColor = [];
			engagementBars.datasets[0].data = [];

			for (var i = 0; i < engagementBars.labels.length; i++)
				engagementBars.datasets[0].data.push(0);

			impressionBreakdown.datasets[0].data = [creative.impressionCount, creative.interactionCount, creative.clickCount];

			// number of data points to show
			var numDataPoints = creative.sessions.reduce((acc, element) => acc + element.events.length, 0);
			if (numDataPoints > 240) numDataPoints = 240;

			// find oldest event
			var lowerBounds = new Date(creative.sessions[0].events[0].dateTime).getTime();
			creative.sessions.forEach(session => {
				var dateTimes = session.events.map(d => new Date(d.dateTime).getTime());
				dateTimes.forEach(dateTime => {
					if (dateTime < lowerBounds) lowerBounds = dateTime;
				});
			});

			// set upper bounds to now
			const upperBounds = new Date(Date.now()).getTime();

			// set total time period to work with
			const totalBounds = upperBounds - lowerBounds;

			// set time step size
			const stepSize = Math.floor(totalBounds / numDataPoints);
			
			// begin at lower bounds
			var timeStep = lowerBounds;

			// generate time labels
			for (var i = 0; i < numDataPoints; i++) {
				var minutes = new Date(timeStep).getMinutes();
				var hour = new Date(timeStep).getHours();
				var day = new Date(timeStep).getDate();
				var month = new Date(timeStep).getMonth() + 1;

				var timeString = 
				(month < 10 ? "0" + month : month) + "-" + 
				(day < 10 ? "0" + day : day) + "-" + 
				(hour < 10 ? "0" + hour : hour) + ":" + 
				(minutes < 10 ? "0" + minutes : minutes);

				impressionTimeline.labels.push(timeString);
				impressionTimeline.datasets[0].data.push(0);
				impressionTimeline.datasets[1].data.push(0);
				impressionTimeline.datasets[2].data.push(0);
				actionTimeline.labels.push(timeString);
				actionTimeline.datasets[0].data.push(0);
				actionTimeline.datasets[1].data.push(0);
				actionTimeline.datasets[2].data.push(0);
				actionTimeline.datasets[3].data.push(0);
				rateTimeline.labels.push(timeString);
				engagementTimeline.labels.push(timeString);
				engagementTimeline.datasets[0].data.push(0);

				timeStep += stepSize;
			}

			// sort all events into the time step buckets
			creative.sessions.forEach(session => {
				session.events.forEach(event => {
					if (event.eventType === "impression") {
						impressionTimeline.datasets[0].data[Math.floor((event.dateTime - lowerBounds) / stepSize)]++;
					}
					if (event.eventType === "first-interaction" || event.eventType === "first-click") {
						impressionTimeline.datasets[1].data[Math.floor((event.dateTime - lowerBounds) / stepSize)]++;
					}
					if (event.eventType === "click-through") {
						impressionTimeline.datasets[2].data[Math.floor((event.dateTime - lowerBounds) / stepSize)]++;
					}
					if (event.eventType === "rotation") {
						actionTimeline.datasets[0].data[Math.floor((event.dateTime - lowerBounds) / stepSize)]++;
					}
					if (event.eventType === "zoom") {
						actionTimeline.datasets[1].data[Math.floor((event.dateTime - lowerBounds) / stepSize)]++;
					}
					if (event.eventType === "variant") {
						actionTimeline.datasets[2].data[Math.floor((event.dateTime - lowerBounds) / stepSize)]++;
						var variant = variantBreakdown.labels.find(v => v === event.eventData.id);
						if (variant != null) {
							variantBreakdown.datasets[0].data[variantBreakdown.labels.indexOf(variant)]++;
						}
						else {
							variantBreakdown.labels.push(event.eventData.id);
							variantBreakdown.datasets[0].data.push(1);
							variantBreakdown.datasets[0].backgroundColor.push(event.eventData.id);
						}
					}
					if (event.eventType === "reset") {
						actionTimeline.datasets[3].data[Math.floor((event.dateTime - lowerBounds) / stepSize)]++;
					}
				});
			});
			

			for (var i = 0; i < numDataPoints; i++) {
				if (impressionTimeline.datasets[0].data[i] == 0) {
					rateTimeline.datasets[0].data.push(0);
					rateTimeline.datasets[1].data.push(0);
				}
				else {
					rateTimeline.datasets[0].data.push(impressionTimeline.datasets[1].data[i] / impressionTimeline.datasets[0].data[i]);
					rateTimeline.datasets[1].data.push(impressionTimeline.datasets[2].data[i] / impressionTimeline.datasets[0].data[i]);
				}
			}

			if (creative.sessions.length > 0) {
				var interactionsPerInterval = [];
				for (var i = 0; i < numDataPoints; i++) {
					interactionsPerInterval.push(0);
				}

				creative.sessions.forEach(session => {
					if (session.hasInteraction) {
						session.interactionTime = session.interactionEnd - session.interactionStart;

						if (session.interactionTime < maxInteractionTime) {
							var index = Math.floor((session.interactionEnd - lowerBounds) / stepSize);
							engagementTimeline.datasets[0].data[index] += session.interactionTime;
							interactionsPerInterval[index]++;

							if (session.interactionTime < 1000)
								engagementBars.datasets[0].data[0]++;
							else if (session.interactionTime < 2000)
								engagementBars.datasets[0].data[1]++;
							else if (session.interactionTime < 3000)
								engagementBars.datasets[0].data[2]++;
							else if (session.interactionTime < 4000)
								engagementBars.datasets[0].data[3]++;
							else if (session.interactionTime < 5000)
								engagementBars.datasets[0].data[4]++;
							else if (session.interactionTime < 7000)
								engagementBars.datasets[0].data[5]++;
							else if (session.interactionTime < 10000)
								engagementBars.datasets[0].data[6]++;
							else
								engagementBars.datasets[0].data[7]++;
						}
					}
				});

				for (var i = 0; i < numDataPoints; i++) {
					if (interactionsPerInterval[i] != 0) {
						engagementTimeline.datasets[0].data[i] /= interactionsPerInterval[i] * 1000;
					}
				}
			}
			else {
				console.log("ERROR: No sessions generated in timeline");
			}

			renderTimeline(impressionTimeline);
		};

		function renderTimeline(data) {
			// clean canvas to avoid rendering bug
			const $canvas = $("#chart-timeline");
			$("#chart-timeline").after("<canvas id=\"chart-timeline\"></canvas>");
			$canvas.remove();

			// populate canvas with chart
			var ctx1 = document.getElementById("chart-timeline").getContext("2d");
			var chart = new Chart(ctx1, {
		    	// The type of chart we want to create
		    	type: "line",

		    	// The data for our dataset
		    	data: data,

	    		// Configuration options go here
	    		options: {}
	    	});
		};

		function showCreative (creativeId, e) {
			if (e) {
				$("tr").removeClass("active");
				$(e.target).closest("tr").addClass("active");
			}

			const creativeDataURL = "/creative/" + creativeId;

			fetch(creativeDataURL).then(data => data.json()).then(res => {
				generateChartsData(res);
				renderBreakdowns();

				// regenerate charts
			}).catch(error => {
				console.log(error);
			});
		};

		function renderCreativeTable(tableData) {
			var $table = $(".table-data");

			var cols = Object.keys(tableData[0]);
			$table.append("<thead><tr>" + cols.map(col => "<th class=\"table-column\">" + col + "</th>").join("") + "</tr></thead>");


			tableData.map(function(row) {
				var cols = Object.values(row);
				const $row = $("<tr>" + cols.map(col => "<td>" + col + "</td>").join("")  + "</tr>");
				const $button = $("<button>View</button>").click(e => showCreative(row.creativeId, e));
				$row.append($button);
				$table.append($row);
			});
		};
	</script>
</body>
</html>
